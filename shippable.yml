language: php

php:
  - 5.4

services:
  - mysql

addons:
  hosts:
    - host1.local
cache: true
before_script:
  - sudo apt-get update
  - sudo apt-get install nginx
  - sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
  - ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm

  - sudo cp -f config/site-nginx.conf /etc/nginx/sites-available/site-nginx.conf
  - sudo sed -e "s?%BUILD_DIR%?$(pwd)?g" --in-place /etc/nginx/sites-available/site-nginx.conf
  - sudo rm -rf /etc/nginx/sites-enabled/site-nginx.conf
  - sudo ln -s "/etc/nginx/sites-available/site-nginx.conf" "/etc/nginx/sites-enabled/site-nginx.conf"
  - cat /etc/nginx/sites-enabled/site-nginx.conf
  - cat /etc/nginx/sites-available/default
  - sudo rm -rf /etc/nginx/sites-available/default
  - cat /etc/hosts
  - cat ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
  - ls -l /etc/nginx/sites-enabled/
  - sudo service nginx restart
  - composer install -n --prefer-source
script:
  - phpunit  --log-junit shippable/testresults/junit.xml --coverage-xml shippable/codecoverage tests/ExampleTest.php
after_script:
  - sudo service nginx stop